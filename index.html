<!DOCTYPE html>
<html>
<head>
  <title>TruthLayer</title>
</head>

<body>

  <h1>TruthLayer is Working ✅</h1>
  <p>Hello from VS Code</p>

  <!-- LINK INPUT -->
  <input id="linkInput" placeholder="Paste a link here" />
  <button id="submitBtn">Submit</button>
  <button id="autopsyBtn">Run Link Autopsy</button>

  <hr>

  <!-- EMAIL AUTOPSY -->
  <h3>Email Autopsy</h3>
  <textarea id="emailInput" placeholder="Paste email content here"></textarea>
  <br>
  <button id="emailAutopsyBtn">Run Email Autopsy</button>
  <p id="emailResult"></p>

  <hr>

  <!-- OFFER / SMS AUTOPSY -->
  <h3>Offer / SMS Autopsy</h3>
  <textarea id="offerInput" placeholder="Paste offer / SMS text here"></textarea>
  <br>
  <button id="offerAutopsyBtn">Run Offer Autopsy</button>
  <p id="offerResult"></p>

  <!-- =========================
       FIREBASE + LOGIC
       ========================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      getDocs,
      query,
      orderBy,
      limit,
      where
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqnrltsLxes0eLmjBr1zgPaDWoRzqghj8",
      authDomain: "truthlayer-c06ef.firebaseapp.com",
      projectId: "truthlayer-c06ef",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    signInAnonymously(auth).catch(console.error);

    onAuthStateChanged(auth, (user) => {
      if (!user) return;

      // =========================
      // LINK SAVE
      // =========================
      submitBtn.onclick = async () => {
        const link = linkInput.value.trim();
        if (!link) return alert("Paste a link");

        const cleaned = link.toLowerCase()
          .replace("https://", "")
          .replace("http://", "")
          .replace(/\/$/, "");

        await addDoc(collection(db, "evidence"), {
          type: "link",
          rawInput: link,
          normalized: {
            domain: cleaned.split("/")[0]
          },
          ownerId: user.uid,
          createdAt: serverTimestamp()
        });

        alert("Link saved");
        linkInput.value = "";
      };

      // =========================
      // LINK AUTOPSY
      // =========================
      autopsyBtn.onclick = async () => {
        const q = query(
          collection(db, "evidence"),
          where("ownerId", "==", user.uid),
          orderBy("createdAt", "desc"),
          limit(1)
        );

        const snap = await getDocs(q);
        if (snap.empty) return alert("No link found");

        const data = snap.docs[0].data();
        const flags = [];

        if (!data.rawInput.startsWith("https://")) flags.push("NO_HTTPS");
        if (data.normalized.domain.length > 20) flags.push("LONG_DOMAIN");
        if (/\d/.test(data.normalized.domain)) flags.push("NUMERIC_DOMAIN");

        alert(
          flags.length
            ? "⚠️ Risk Flags: " + flags.join(", ")
            : "✅ Link seems safe"
        );
      };

      // =========================
      // EMAIL AUTOPSY
      // =========================
      emailAutopsyBtn.onclick = async () => {
        const text = emailInput.value
          .toLowerCase()
          .replace(/[^a-z0-9₹\s]/g, " ");

        if (!text.trim()) return alert("Paste email");

        const flags = [];

        ["urgent", "immediately", "action required"].forEach(w => {
          if (text.includes(w)) flags.push(`URGENCY:${w}`);
        });

        ["verify", "click here", "login", "password"].forEach(w => {
          if (text.includes(w)) flags.push(`PHISHING:${w}`);
        });

        emailResult.innerText =
          flags.length
            ? "⚠️ Likely Scam\n" + flags.join(", ")
            : "✅ Likely Safe";

        await addDoc(collection(db, "autopsies"), {
          type: "email",
          rawText: emailInput.value,
          findings: flags,
          ownerId: user.uid,
          createdAt: serverTimestamp()
        });

        emailInput.value = "";
      };

      // =========================
      // OFFER / SMS AUTOPSY
      // =========================
      offerAutopsyBtn.onclick = async () => {
        const text = offerInput.value
          .toLowerCase()
          .replace(/[^a-z0-9₹\s]/g, " ");

        if (!text.trim()) return alert("Paste offer");

        const flags = [];

        [
          "urgent", "immediately", "limited time",
          "account suspended", "verify now", "act now"
        ].forEach(w => {
          if (text.includes(w)) flags.push(`URGENCY:${w}`);
        });

        ["click here", "verify", "login", "password"].forEach(w => {
          if (text.includes(w)) flags.push(`PHISHING:${w}`);
        });

        ["pay", "upi", "₹", "rs", "processing fee"].forEach(w => {
          if (text.includes(w)) flags.push(`PAYMENT:${w}`);
        });

        offerResult.innerText =
          flags.length
            ? "⚠️ Likely Scam\n" + flags.join(", ")
            : "✅ Likely Safe";

        await addDoc(collection(db, "autopsies"), {
          type: "offer",
          rawText: offerInput.value,
          findings: flags,
          ownerId: user.uid,
          createdAt: serverTimestamp()
        });

        offerInput.value = "";
      };
    });
  </script>

</body>
</html>
